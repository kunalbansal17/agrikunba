"use strict";(()=>{var a={};a.id=465,a.ids=[465],a.modules={3827:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{config:()=>l,default:()=>k});var e=c(7984),f=c(4975),g=c(5511),h=c(9695),i=a([e]);e=(i.then?(await i)():i)[0];let l={api:{bodyParser:{sizeLimit:"1mb"}}},m=new e.default({apiKey:process.env.OPENAI_API_KEY}),n=`
You are ðŸŒ± KrishiGPT â€” Indiaâ€™s Agriculture Guide.
- Speak in the user's chosen language, be concise, friendly, and use a few helpful emojis.
- Answer strictly in user's chosen language. Do not switch languages unless explicitly asked.
- Focus on crops, livestock, mandi prices, weather, warehouses, and government schemes.
- When asked for actionable advice, be practical and safe; cite assumptions or data snapshots if provided.
- If a topic is outside agriculture, gently steer the user back with a relevant suggestion.
- Consider all queries agriculture-related unless explicitly personal.
`;async function j(a){let b={chatId:a.chatId,role:a.role??"SYSTEM",model:a.model,content:"string"==typeof a.content?a.content:JSON.stringify(a.content)};try{await f.z.message.create({data:b})}catch{await f.z.message.create({data:{...b,role:"ASSISTANT"}})}}async function k(a,b){if("POST"!==a.method)return b.status(405).end();let{chatId:c,message:d,lang:e="en",visitorId:i,loc:k,temperature:l=.6,max_tokens:o=512}=a.body??{};if(!d||"string"!=typeof d)return b.status(400).json({error:"NO_MESSAGE"});try{let p=function(a,b,c){let d=(c??"").trim()||a.cookies?.agk_vid||"";if(d||(d=`v_${(0,g.randomUUID)()}`),a.cookies?.agk_vid!==d){let a=new Date(Date.now()+31536e6);b.setHeader("Set-Cookie",`agk_vid=${d}; Path=/; HttpOnly; SameSite=Lax; Expires=${a.toUTCString()}`)}return d}(a,b,i??null),q=c?await f.z.chat.findUnique({where:{id:c}}):null;q||(q=await f.z.chat.create({data:{visitorId:p,lang:e}})),await f.z.message.create({data:{chatId:q.id,role:"USER",content:d,model:"user"}});let r=await f.z.message.create({data:{chatId:q.id,role:"ASSISTANT",content:"",model:"gpt-4o-mini"},select:{id:!0}}),s=await m.chat.completions.create({model:"gpt-4o-mini",temperature:0,response_format:{type:"json_schema",json_schema:{name:"WeatherIntent",schema:{type:"object",properties:{need_weather:{type:"boolean"},place_text:{type:"string"},activity:{type:"string",enum:["none","spray","irrigate"]},timeframe:{type:"string",enum:["today","tomorrow","next_48h","none"]},confidence:{type:"number",minimum:0,maximum:1}},required:["need_weather"],additionalProperties:!1}}},messages:[{role:"system",content:"Infer if answering requires weather. Handle any language. Extract timeframe if user says 'today', 'tomorrow', 'next 48h'."},{role:"user",content:d}]}),t=!1,u="",v="none",w="none";try{let a=JSON.parse(s.choices[0]?.message?.content??"{}");t=!!a?.need_weather,u=(a?.place_text??"").trim(),v=a?.timeframe||"none",w=a?.activity==="spray"||a?.activity==="irrigate"?a.activity:"none","number"==typeof a?.confidence&&a.confidence<.45&&(t=!1)}catch{t=!1}let x=function(a){let b=a.match(/\b[1-9]\d{5}\b/);return b?b[0]:null}(d),y=k?.lat,z=k?.lon,A=k?"your location":"";if((null==y||null==z)&&u){let a=await (0,h.Yr)(u,e);a&&(y=a.latitude,z=a.longitude,A=[a.name,a.admin1].filter(Boolean).join(", "),await j({chatId:q.id,model:"ctx:location",content:{source:"place_text",place_text:u,label:A,country:a.country,lat:y,lon:z,pincode:x||null,ts:new Date().toISOString()}}))}else if(null==y||null==z){let a=await f.z.message.findFirst({where:{chatId:q.id,model:"ctx:location"},orderBy:{createdAt:"desc"}});if(a){let b=JSON.parse(a.content);y=b.lat,z=b.lon,A=b.label}}let B="";if(t&&null!=y&&null!=z){let a=await (0,h.qv)(y,z);if(a){a.place=A||"Selected location";let b=(0,h.u$)(a.place,a);"today"===v?b=`ðŸŒ¤ï¸ Today in ${a.place}: rain chance ${a.today.precipProbMax}%, total ${a.today.precipSumMm}mm.`:"tomorrow"===v&&(b=`ðŸŒ§ï¸ Tomorrow in ${a.place}: rain chance ${a.today.precipProbMax}%, total ${a.today.precipSumMm}mm.`);let c="none"!==w?(0,h.i7)(a,w):null;B=`[WEATHER]
${b}
`+(c?`Decision for ${w}: ${c.decision} â€” ${c.reason}
`:""),await j({chatId:q.id,model:"ctx:weather",content:{label:a.place,summary:b,activity:w,decision:c,ts:new Date().toISOString()}})}}let C=`${n}
${B}
Keep output clean.`;b.writeHead(200,{"Content-Type":"text/plain; charset=utf-8","Transfer-Encoding":"chunked","Cache-Control":"no-store","X-Chat-Id":q.id,"X-Assistant-Id":r.id,"X-Visitor-Id":p});let D=await m.chat.completions.create({model:"gpt-4o-mini",stream:!0,temperature:l,max_tokens:o,messages:[{role:"system",content:C},{role:"user",content:d}]}),E="";for await(let a of D){let c=a.choices?.[0]?.delta?.content??"";c&&(E+=c,b.write(c))}await f.z.message.update({where:{id:r.id},data:{content:E}});try{let a=await m.chat.completions.create({model:"gpt-4o-mini",temperature:.2,max_tokens:120,response_format:{type:"json_schema",json_schema:{name:"Suggestions",schema:{type:"object",properties:{suggestions:{type:"array",items:{type:"string"},minItems:3,maxItems:3}},required:["suggestions"],additionalProperties:!1}}},messages:[{role:"system",content:"Generate 3 short follow-up questions in the same language. Under 12 words. Use real scheme/crop/place names when possible."},{role:"user",content:`Language: ${e}
User asked: ${d}
Assistant replied: ${E}`}]}),b=JSON.parse(a.choices[0]?.message?.content??"{}"),c=Array.isArray(b?.suggestions)?b.suggestions:[];3===c.length&&await j({chatId:q.id,model:"suggestions:v1",content:{parentAssistantId:r.id,suggestions:c,ts:new Date().toISOString()}})}catch{}b.end()}catch(a){try{b.write(`

Sorry, I hit an error. ${String(a?.message??a)} ðŸ˜”`),b.end()}catch{}}}d()}catch(a){d(a)}})},4975:(a,b,c)=>{c.d(b,{z:()=>e});let d=require("@prisma/client"),e=global.prisma||new d.PrismaClient({log:["query","error","warn"]})},5511:a=>{a.exports=require("crypto")},5600:a=>{a.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},7867:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{config:()=>o,default:()=>n,handler:()=>m});var e=c(1223),f=c(4600),g=c(4409),h=c(6440),i=c(3827),j=c(9275),k=c(879),l=a([i]);i=(l.then?(await l)():l)[0];let n=(0,h.M)(i,"default"),o=(0,h.M)(i,"config"),p=new g.PagesAPIRouteModule({definition:{kind:f.A.PAGES_API,page:"/api/krishigpt/chat",pathname:"/api/krishigpt/chat",bundlePath:"",filename:""},userland:i,distDir:".next",relativeProjectDir:""});async function m(a,b,c){let d=await p.prepare(a,b,{srcPage:"/api/krishigpt/chat"});if(!d){b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve());return}let{query:f,params:g,prerenderManifest:h,routerServerContext:i}=d;try{let c=a.method||"GET",d=(0,j.getTracer)(),e=d.getActiveScopeSpan(),l=p.instrumentationOnRequestError.bind(p),m=async e=>p.render(a,b,{query:{...f,...g},params:g,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:h.preview,propagateError:!1,dev:p.isDev,page:"/api/krishigpt/chat",internalRevalidate:null==i?void 0:i.revalidate,onError:(...b)=>l(a,...b)}).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let f=d.getRootSpanAttributes();if(!f)return;if(f.get("next.span_type")!==k.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${f.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let g=f.get("next.route");if(g){let a=`${c} ${g}`;e.setAttributes({"next.route":g,"http.route":g,"next.span_name":a}),e.updateName(a)}else e.updateName(`${c} ${a.url}`)});e?await m(e):await d.withPropagatedContext(a.headers,()=>d.trace(k.BaseServerSpan.handleRequest,{spanName:`${c} ${a.url}`,kind:j.SpanKind.SERVER,attributes:{"http.method":c,"http.target":a.url}},m))}catch(a){if(p.isDev)throw a;(0,e.sendError)(b,500,"Internal Server Error")}finally{null==c.waitUntil||c.waitUntil.call(c,Promise.resolve())}}d()}catch(a){d(a)}})},7984:a=>{a.exports=import("openai")},9695:(a,b,c)=>{async function d(a){try{let b,c=`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(a)}&key=${process.env.GOOGLE_MAPS_KEY}`,d=await fetch(c);if(!d.ok)return null;let e=await d.json();if(!e.results||0===e.results.length)return null;let f=e.results[0],g=f.geometry.location,h=f.address_components.find(a=>a.types.includes("postal_code"));return h&&(b=h.long_name),{name:f.formatted_address,admin1:"",country:"",latitude:g.lat,longitude:g.lng,pincode:b,provider:"google"}}catch(a){return console.error("Google geocode error:",a),null}}async function e(a,b="en"){if(!a)return null;let c=await d(a);if(c)return c;let f=new URL("https://geocoding-api.open-meteo.com/v1/search");f.searchParams.set("name",a),f.searchParams.set("count","1"),f.searchParams.set("language",b),f.searchParams.set("country","IN");let g=await fetch(f.toString(),{cache:"no-store"});if(!g.ok)return null;let h=await g.json(),i=h?.results?.[0];if(!i&&/[,.-]/.test(a)){let c=a.split(/[,-.]/).map(a=>a.trim()).filter(Boolean).pop();if(c&&c.toLowerCase()!==a.toLowerCase())return e(c,b)}return i?{name:i.name,admin1:i.admin1,country:i.country,latitude:i.latitude,longitude:i.longitude,provider:"open-meteo"}:null}async function f(a,b){let c=new URL("https://api.open-meteo.com/v1/forecast");c.searchParams.set("latitude",String(a)),c.searchParams.set("longitude",String(b)),c.searchParams.set("timezone","auto"),c.searchParams.set("current_weather","true"),c.searchParams.set("hourly","precipitation_probability,precipitation,wind_speed_10m,relative_humidity_2m"),c.searchParams.set("daily","precipitation_probability_max,precipitation_sum,wind_speed_10m_max,temperature_2m_max,temperature_2m_min"),c.searchParams.set("windspeed_unit","kmh"),c.searchParams.set("precipitation_unit","mm");let d=await fetch(c.toString(),{cache:"no-store"});if(!d.ok)return null;let e=await d.json(),f={place:"",lat:a,lon:b,now:e.current_weather?{tempC:e.current_weather.temperature,windKmh:e.current_weather.windspeed,weathercode:e.current_weather.weathercode}:void 0,today:{precipProbMax:e?.daily?.precipitation_probability_max?.[0],precipSumMm:e?.daily?.precipitation_sum?.[0],windMaxKmh:e?.daily?.wind_speed_10m_max?.[0],tMinC:e?.daily?.temperature_2m_min?.[0],tMaxC:e?.daily?.temperature_2m_max?.[0]},next48h:[]},g=e?.hourly?.time??[],h=e?.hourly?.precipitation_probability??[],i=e?.hourly?.precipitation??[],j=e?.hourly?.wind_speed_10m??[],k=e?.hourly?.relative_humidity_2m??[];for(let a=0;a<Math.min(g.length,48);a++)f.next48h.push({iso:g[a],precipProb:h?.[a],precipMm:i?.[a],windKmh:j?.[a],rh:k?.[a]});return f}function g(a,b){let c=a.next48h.slice(0,6),d=a.next48h.slice(0,12),e=a.next48h.slice(0,24),f=Math.max(...c.map(a=>a.precipProb??0)),g=Math.max(...c.map(a=>a.windKmh??0)),h=c.reduce((a,b)=>a+(b.precipMm??0),0),i=Math.max(...e.map(a=>a.precipProb??0)),j=e.reduce((a,b)=>a+(b.precipMm??0),0);return"spray"===b?f>=40||h>=1||g>=15?{decision:"NO_GO",reason:"High rain chance or strong wind in next 6h."}:{decision:"GO",reason:d.some(a=>(a.precipProb??0)<30&&(a.windKmh??0)<12&&(a.rh??60)<=85)?"Favorable window in next 12h.":"Conditions acceptable."}:j>=5||i>=60?{decision:"NO_GO",reason:"Rain likely; save water & reassess after rainfall."}:{decision:"GO",reason:"Low rain risk; irrigation suitable."}}function h(a,b){let c=b.today,d=Math.max(...b.next48h.map(a=>a.precipProb??0)),e=Math.max(...b.next48h.map(a=>a.windKmh??0));return[`Weather@${a} (lat ${b.lat.toFixed(2)}, lon ${b.lon.toFixed(2)})`,b.now?.tempC!=null?`Now: ${b.now.tempC}\xb0C, wind ${Math.round(b.now.windKmh??0)} km/h`:"",`Today: rain prob max ${c.precipProbMax??"-"}%, rain total ${c.precipSumMm??"-"} mm, wind max ${c.windMaxKmh??"-"} km/h, Tmin/Tmax ${c.tMinC??"-"}\xb0/${c.tMaxC??"-"}\xb0C`,`Next 48h peaks: rain prob ${d}%, wind ${Math.round(e)} km/h`].filter(Boolean).join(" â€¢ ")}c.d(b,{Yr:()=>e,i7:()=>g,qv:()=>f,u$:()=>h})}};var b=require("../../../webpack-api-runtime.js");b.C(a);var c=b.X(0,[929],()=>b(b.s=7867));module.exports=c})();